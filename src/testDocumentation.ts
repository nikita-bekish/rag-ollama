import {
  answerWithRAG,
  answerWithoutRAG,
  type AnswerWithSources,
} from "./ragPipeline";

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
 */
function formatAnswerWithSources(result: AnswerWithSources): string {
  let output = result.answer.trim();

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é "–ò—Å—Ç–æ—á–Ω–∏–∫–∏"
  if (result.sources.length > 0) {
    output += "\n\nüìö –ò–°–¢–û–ß–ù–ò–ö–ò:\n";
    output += "‚îÄ".repeat(80) + "\n";

    result.sources.forEach((source) => {
      output += `${source.id} ${source.file} (${source.chunkId})\n`;
      output += `   Score: ${source.score.toFixed(4)}\n`;
      output += `   "${source.preview}"\n\n`;
    });
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  output += "üîç –°–¢–ê–¢–£–° –¶–ò–¢–ò–†–û–í–ê–ù–ò–Ø:\n";
  output += "‚îÄ".repeat(80) + "\n";
  output += `–ù–∞–π–¥–µ–Ω–æ —Ü–∏—Ç–∞—Ç: ${result.foundCitations.join(", ") || "–Ω–µ—Ç"}\n`;
  output += `–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω—ã: ${
    result.hasAllCitations ? "‚úÖ –î–ê" : "‚ö†Ô∏è –ù–ï–¢"
  }\n`;

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è—Ö
  if (result.hallucinations.length > 0) {
    output += "\n‚ö†Ô∏è –í–û–ó–ú–û–ñ–ù–´–ï –ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–ò:\n";
    output += "‚îÄ".repeat(80) + "\n";
    result.hallucinations.forEach((issue) => {
      output += `${issue}\n`;
    });
  } else {
    output += "\n‚úÖ –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ\n";
  }

  return output;
}

/**
 * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
 */
async function testQuestion(
  questionNum: number,
  question: string,
  expectedBehavior: string
) {
  console.log("\n" + "=".repeat(80));
  console.log(`–¢–ï–°–¢ ${questionNum}: ${question}`);
  console.log("–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: " + expectedBehavior);
  console.log("=".repeat(80));

  // –†–µ–∂–∏–º 1: –ë–ï–ó RAG (baseline)
  console.log("\nüîπ –†–ï–ñ–ò–ú –ë–ï–ó RAG:");
  console.log("-".repeat(80));
  try {
    const answerNoRAG = await answerWithoutRAG(question);
    console.log(answerNoRAG.trim());
  } catch (err: any) {
    console.error("–û—à–∏–±–∫–∞:", err.message);
  }

  // –†–µ–∂–∏–º 2: –° RAG –ò –¶–ò–¢–ê–¢–ê–ú–ò
  console.log("\nüîπ –†–ï–ñ–ò–ú –° RAG –ò –¶–ò–¢–ê–¢–ê–ú–ò:");
  console.log("-".repeat(80));
  try {
    const resultWithRAG = await answerWithRAG(question);
    console.log(formatAnswerWithSources(resultWithRAG));
  } catch (err: any) {
    console.error("–û—à–∏–±–∫–∞:", err.message);
  }

  console.log("\n" + "=".repeat(80) + "\n");
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî 10 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
 */
async function main() {
  console.log("\nüöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï RAG –ù–ê –†–ï–ê–õ–¨–ù–û–ô –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò\n");
  console.log(
    "–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è: Python asyncio, Docker, –∏ –¥—Ä—É–≥–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã\n"
  );

  // ===== ASYNCIO TESTS =====

  // –¢–ï–°–¢ 1: –ü—Ä–æ—Å—Ç–æ–π —Ñ–∞–∫—Ç
  await testQuestion(
    1,
    "–í –∫–∞–∫–æ–π –≤–µ—Ä—Å–∏–∏ Python –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω —Å–∏–Ω—Ç–∞–∫—Å–∏—Å async/await?",
    "–û—Ç–≤–µ—Ç: Python 3.5 —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // –¢–ï–°–¢ 2: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å —Å —Ç–æ—á–Ω—ã–º —á–∏—Å–ª–æ–º
  await testQuestion(
    2,
    "–ö–æ–≥–¥–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è asyncio.run() –≤ Python?",
    "–û—Ç–≤–µ—Ç: Python 3.7 —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // –¢–ï–°–¢ 3: –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å
  await testQuestion(
    3,
    "–ß—Ç–æ —Ç–∞–∫–æ–µ Event Loop –≤ asyncio?",
    "–û—Ç–≤–µ—Ç: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ Event Loop —Å —Ü–∏—Ç–∞—Ç–æ–π –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
  );

  // –¢–ï–°–¢ 4: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å —Å –∫–æ–¥–æ–º
  await testQuestion(
    4,
    "–ö–∞–∫–æ–π –º–æ–¥—É–ª—å –Ω—É–∂–µ–Ω –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ timeout –Ω–∞ –∫–æ—Ä—É—Ç–∏–Ω—É?",
    "–û—Ç–≤–µ—Ç: asyncio.wait_for() —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // ===== DOCKER TESTS =====

  // –¢–ï–°–¢ 5: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
  await testQuestion(
    5,
    "–ß—Ç–æ —Ç–∞–∫–æ–µ Docker Image?",
    "–û—Ç–≤–µ—Ç: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Docker Image —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // –¢–ï–°–¢ 6: –ö–æ–º–∞–Ω–¥–∞
  await testQuestion(
    6,
    "–ö–∞–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤—ã–≤–æ–¥–∏—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)?",
    "–û—Ç–≤–µ—Ç: docker ps -a —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // –¢–ï–°–¢ 7: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  await testQuestion(
    7,
    "–ö–∞–∫ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ—Ä—Ç –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ?",
    "–û—Ç–≤–µ—Ç: —Ñ–ª–∞–≥ -p 8080:80 —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // –¢–ï–°–¢ 8: Best Practice
  await testQuestion(
    8,
    "–ü–æ—á–µ–º—É –Ω—É–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å —Ç–µ–≥–∞ 'latest' –≤ production?",
    "–û—Ç–≤–µ—Ç: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª—É—á—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å —Ü–∏—Ç–∞—Ç–æ–π"
  );

  // ===== CROSS-DOCUMENT TEST =====

  // –¢–ï–°–¢ 9: –í–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
  await testQuestion(
    9,
    "–ö–∞–∫–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—ã–ª–∏ –≤ Kubernetes v2.0?",
    "–û—Ç–≤–µ—Ç: '–í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏' –±–µ–∑ —Ü–∏—Ç–∞—Ç"
  );

  // –¢–ï–°–¢ 10: –í–æ–ø—Ä–æ—Å —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–µ–π
  await testQuestion(
    10,
    "–ö–∞–∫–æ–≤–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è Docker –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å asyncio?",
    "–û—Ç–≤–µ—Ç: —á–µ—Å—Ç–Ω—ã–π –æ—Ç–∫–∞–∑ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ä–∞–∑–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –∏ –Ω–µ —Å–≤—è–∑–∞–Ω–∞)"
  );

  console.log("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n");

  // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  console.log("üìä –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê:");
  console.log("‚îÄ".repeat(80));
  console.log("–î–ª—è –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:");
  console.log("  ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å: –û—Ç–≤–µ—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞–º?");
  console.log("  ‚úÖ –¶–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –í—Å–µ —Ñ–∞–∫—Ç—ã –∏–º–µ—é—Ç [N]?");
  console.log("  ‚úÖ –ß–µ—Å—Ç–Ω–æ—Å—Ç—å: –û—Ç–∫–∞–∑—ã–≤–∞–µ—Ç –ª–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏?");
  console.log("  ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: –û–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –ª–∏ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏?");
  console.log("  ‚úÖ –§—Ä–∞–≥–º–µ–Ω—Ç—ã: –ü–æ–∫–∞–∑–∞–Ω—ã –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã?");
}

// –ó–∞–ø—É—Å–∫
main().catch((err) => {
  console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", err);
  process.exit(1);
});
